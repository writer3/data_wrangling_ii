---
title: "Reading Data From the Web"
output: github_document
---

Viridis

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Load the necessary libraries

```{r}
library(rvest) #facilitates web scraping
library(httr)
```


```{r}
url = "http://samhda.s3-us-gov-west-1.amazonaws.com/s3fs-public/field-uploads/2k15StateFiles/NSDUHsaeShortTermCHG2015.htm"

drug_use_html = read_html(url)
```

```{r}
marj_use_df = 
  drug_use_html |> 
  html_table() |> 
  first() |> #takes first element out of the table or first table, can type in command line ?first to see if you can import an nth function to specify other elements
  slice(-1) #subtracts first row
```

Learning asssessment: Create a data frame that contains the cost of living table for New York from https://www.bestplaces.net/cost_of_living/city/new_york/new_york.

```{r}
nyc_cost_df =
  read_html("https://www.bestplaces.net/cost_of_living/city/new_york/new_york") |> 
  html_table(header = TRUE) |> #header says first row is header
  first()
```

## CSS Selectors

```{r}
url = "https://www.imdb.com/list/ls070150896/"

swm_html = read_html(url)
```

How to figure out which pieces from html I want. 
1. Selector gadget
2. pick movie title (green)
3. clear something else you dont want (red)
4. At the bottom of web page, you'll see the full CSS tag that you copy and paste into html_element function

```{r}
swm_html |> 
  html_elements(".ipc-title-link-wrapper .ipc-title__text") |> 
  html_text() #extract text from the element above

swm_html |> 
  html_elements(".dli-title-metadata-item:nth-child(2)") |> 
  html_text()

swm_html |> 
  html_elements(".metacritic-score-box") |> 
  html_text()
```

It would look like this to make a table:

```{r}
title_vec = 
  swm_html |>
  html_elements(".ipc-title-link-wrapper .ipc-title__text") |>
  html_text()

metascore_vec = 
  swm_html |>
  html_elements(".metacritic-score-box") |>
  html_text()

runtime_vec = 
  swm_html |>
  html_elements(".dli-title-metadata-item:nth-child(2)") |>
  html_text()

swm_df = 
  tibble(
    title = title_vec,
    score = metascore_vec,
    runtime = runtime_vec
  )
```

Learning assessment: This page contains some (made up) books. Use a process similar to the one above to extract the book titles, stars, and price from https://books.toscrape.com/

```{r}
books_html = read_html("https://books.toscrape.com/")

books_html |> 
  html_elements(".product_pod a") |>
  html_text()
```


## Use API

API knows we are asking for data.

Get water data.
1. https://data.cityofnewyork.us/Environment/Water-Consumption-in-the-City-of-New-York/ia2d-e54m/about_data
2. Actions
3. API
4. API endpoint -> data format to CSV
5. Copy API endpoint

```{r}
nyc_water =
  GET("https://data.cityofnewyork.us/resource/ia2d-e54m.csv") |>   content() #program knows it's csv and outputs just the data
```

Get Behavioral Risk Factor study data

```{r}
brfss_df = 
  GET("https://chronicdata.cdc.gov/resource/acme-vg9e.csv",
      query = list("$limit" = 5000)) |> #breaking the 1000 row limit to 5000 to get more data 
  content()
```
  

Pokemon API

For Bulbasaur 

```{r}
poke = 
  GET("http://pokeapi.co/api/v2/pokemon/1") |>
  content()

poke[["name"]]
```

